CREATE OR REPLACE FUNCTION nota_promedio(xidproy in varchar) return number;
Is
xnota_promedio number;
Begin
	select avg(ca.nota) Into xnota_promedio 
	from califica ca
	where ca.idproy=xidproy;
	return xnota_promedio;
End;

************************************

Declare
Cursor c_proyectos Is 
	select idproy from proyecto;
xidproy varchar(25);
Cursor c_descripciones Is 
	select pr.descripcion, (pe.nombre||' '||pe.apellido) responsable
	from proyecto pr, persona pe
	where pr.docresp=pe.codigo and pr.idproy=xidproy;
xdescripcion varchar(150);
xresponsable varchar(70);
Cursor c_participantes Is 
	select p.codigo, (p.apellido ||' '|| p.nombre) participante
	from estudiante e, persona p
	where e.codigo=p.codigo and e.idproy=xidproy
	order by p.apellido;
xcodigo number;
xparticipante varchar(70);
Cursor c_jurados Is
	select (pe.apellido ||' '|| pe.nombre) jurado, ca.nota
	from persona pe, califica ca
	where pe.codigo=ca.codigo and ca.idproy=xidproy;
xjurado varchar(70);
xnota number;
xnota_promedio number;
Begin
dbms_output.put_line('           LISTADO DE PROYECTOS');
open c_proyectos;
Loop
	Fetch c_proyectos Into xidproy;
	Exit WHEN c_proyectos%NOTFOUND;
	
	open c_descripciones;
	Loop
		Fetch c_descripciones Into xdescripcion, xresponsable;
		Exit WHEN c_descripciones%NOTFOUND;
	
		dbms_output.put_line('PROYECTO    :  ' || xdescripcion);
		dbms_output.put_line(' RESPONSABLE:  ' || xresponsable);

	End Loop;
	Close c_descripciones;

	dbms_output.put_line(' 	       ESTUDIANTES PARTICIPANTES');
	dbms_output.put_line(' 	     =============================');
	open c_participantes;
	Loop
		Fetch c_participantes Into xcodigo, xparticipante;
		Exit WHEN c_participantes%NOTFOUND;
		dbms_output.put_line(' 	     '||xcodigo||' '||xparticipante);
	End Loop;
	Close c_participantes;

	dbms_output.put_line(' 	       JURADO CALIFICAR');
	dbms_output.put_line(' 	     =============================');
	open c_jurados;
	Loop
		Fetch c_jurados Into xjurado, xnota;
		Exit WHEN c_jurados%NOTFOUND;
		dbms_output.put_line(' 	     '||xjurado||' '|| xnota);
	End Loop;
	Close c_jurados;

	dbms_output.put_line(' 	     -----------------------------');
	dbms_output.put_line(' 	     NOTA PROMEDIO: '|| nota_promedio(xidproy));
	dbms_output.put_line(' 	     -----------------------------');
End Loop;
Close c_proyectos;
End
